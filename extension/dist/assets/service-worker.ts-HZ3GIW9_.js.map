{"version":3,"file":"service-worker.ts-HZ3GIW9_.js","sources":["../../src/background/storage.ts","../../src/background/service-worker.ts"],"sourcesContent":["/**\n * Chrome storage utilities with TypeScript types.\n */\n\nimport type { ExtensionStorage, SavedJob } from './messages';\n\nconst STORAGE_KEY = 'riyp_extension_data';\n\n// Default storage state\nconst DEFAULT_STORAGE: ExtensionStorage = {\n    savedJobs: [],\n    lastUpdated: Date.now(),\n};\n\n/**\n * Get the current extension storage\n */\nexport async function getStorage(): Promise<ExtensionStorage> {\n    const result = await chrome.storage.local.get(STORAGE_KEY);\n    return result[STORAGE_KEY] ?? DEFAULT_STORAGE;\n}\n\n/**\n * Update the extension storage\n */\nexport async function setStorage(data: Partial<ExtensionStorage>): Promise<void> {\n    const current = await getStorage();\n    await chrome.storage.local.set({\n        [STORAGE_KEY]: {\n            ...current,\n            ...data,\n            lastUpdated: Date.now(),\n        },\n    });\n}\n\n/**\n * Add a new saved job\n */\nexport async function addSavedJob(job: SavedJob): Promise<void> {\n    const storage = await getStorage();\n\n    // Check if job already exists (by URL)\n    const existingIndex = storage.savedJobs.findIndex((j) => j.url === job.url);\n\n    if (existingIndex >= 0) {\n        // Update existing\n        storage.savedJobs[existingIndex] = job;\n    } else {\n        // Add new (prepend to list)\n        storage.savedJobs.unshift(job);\n    }\n\n    // Keep only last 50 jobs\n    storage.savedJobs = storage.savedJobs.slice(0, 50);\n\n    await setStorage({ savedJobs: storage.savedJobs });\n}\n\n/**\n * Delete a saved job by ID or URL\n */\nexport async function deleteSavedJob(jobIdOrUrl: string): Promise<SavedJob | null> {\n    const storage = await getStorage();\n\n    const index = storage.savedJobs.findIndex(\n        (j) => j.id === jobIdOrUrl || j.url === jobIdOrUrl\n    );\n\n    if (index === -1) {\n        return null;\n    }\n\n    const [deleted] = storage.savedJobs.splice(index, 1);\n    await setStorage({ savedJobs: storage.savedJobs });\n\n    return deleted;\n}\n\n/**\n * Restore a deleted job (for undo)\n */\nexport async function restoreSavedJob(job: SavedJob): Promise<void> {\n    await addSavedJob(job);\n}\n\n/**\n * Get all saved jobs\n */\nexport async function getSavedJobs(): Promise<SavedJob[]> {\n    const storage = await getStorage();\n    return storage.savedJobs;\n}\n\n/**\n * Check if a job URL was already captured\n */\nexport async function isJobCaptured(url: string): Promise<{ captured: boolean; job?: SavedJob }> {\n    const storage = await getStorage();\n    const job = storage.savedJobs.find((j) => j.url === url);\n    return { captured: !!job, job };\n}\n\n/**\n * Update badge with unreviewed job count\n */\nexport async function updateBadge(): Promise<void> {\n    const jobs = await getSavedJobs();\n    const count = jobs.length;\n\n    if (count > 0) {\n        await chrome.action.setBadgeText({ text: String(count) });\n        await chrome.action.setBadgeBackgroundColor({ color: '#0D9488' }); // Brand teal\n    } else {\n        await chrome.action.setBadgeText({ text: '' });\n    }\n}\n","/**\n * Background Service Worker\n * \n * Event-driven background script that:\n * - Handles message passing between popup and content scripts\n * - Manages Chrome storage for saved jobs\n * - Updates extension badge\n * - Calls real RIYP API endpoints\n */\n\nimport type { ExtensionMessage, ExtensionResponse, SavedJob } from './messages';\nimport {\n    addSavedJob,\n    getSavedJobs as getLocalJobs,\n    deleteSavedJob,\n    updateBadge,\n    isJobCaptured\n} from './storage';\nimport {\n    captureJob,\n    getSavedJobs,\n    deleteJob,\n    checkAuth,\n    getLoginUrl,\n    getJobsUrl\n} from './api';\n\n// Message handler\nchrome.runtime.onMessage.addListener(\n    (message: ExtensionMessage, _sender, sendResponse: (response: ExtensionResponse) => void) => {\n        handleMessage(message)\n            .then(sendResponse)\n            .catch((error) => {\n                console.error('[RIYP] Message handler error:', error);\n                sendResponse({ success: false, error: error.message });\n            });\n\n        // Return true to indicate async response\n        return true;\n    }\n);\n\nasync function handleMessage(message: ExtensionMessage): Promise<ExtensionResponse> {\n    switch (message.type) {\n        case 'CAPTURE_JD': {\n            const { jd, meta } = message.payload;\n\n            try {\n                // Try real API first\n                const savedJob = await captureJob(jd, meta);\n\n                // Also save locally for offline access\n                await addSavedJob(savedJob);\n                await updateBadge();\n\n                return { success: true, data: savedJob };\n            } catch (error) {\n                // If API fails (not authenticated), save locally with null score\n                console.warn('[RIYP] API capture failed, saving locally:', error);\n\n                const localJob: SavedJob = {\n                    ...meta,\n                    score: null,\n                    jdPreview: jd.slice(0, 200),\n                };\n\n                await addSavedJob(localJob);\n                await updateBadge();\n\n                return { success: true, data: localJob };\n            }\n        }\n\n        case 'GET_JOBS': {\n            try {\n                // Try to get from API first\n                const apiJobs = await getSavedJobs();\n\n                // Merge with local jobs\n                const localJobs = await getLocalJobs();\n                const mergedJobs = mergeJobs(apiJobs, localJobs);\n\n                return { success: true, data: mergedJobs };\n            } catch {\n                // Fallback to local storage\n                const localJobs = await getLocalJobs();\n                return { success: true, data: localJobs };\n            }\n        }\n\n        case 'DELETE_JOB': {\n            const { jobId } = message.payload;\n\n            try {\n                // Delete from API\n                await deleteJob(jobId);\n            } catch (error) {\n                console.warn('[RIYP] API delete failed (maybe local-only job):', error);\n            }\n\n            // Always delete from local storage\n            await deleteSavedJob(jobId);\n            await updateBadge();\n\n            return { success: true, deleted: jobId };\n        }\n\n        case 'CHECK_AUTH': {\n            const result = await checkAuth();\n            return { success: true, data: result };\n        }\n\n        case 'GET_QUICK_MATCH': {\n            const jobs = await getLocalJobs();\n            const job = jobs.find((j) => j.id === message.payload.jobId);\n\n            if (!job) {\n                return { success: false, error: 'Job not found' };\n            }\n\n            return { success: true, data: { score: job.score ?? 0 } };\n        }\n\n        case 'CHECK_JOB_STATUS': {\n            const { url } = message.payload;\n            const result = await isJobCaptured(url);\n            return {\n                success: true,\n                data: {\n                    captured: result.captured,\n                    score: result.job?.score ?? null,\n                    jobId: result.job?.id\n                }\n            };\n        }\n\n        case 'OPEN_WEBAPP': {\n            const path = message.payload?.path ?? '/jobs';\n            const baseUrl = getJobsUrl().replace('/jobs', ''); // Get base from api.ts\n            await chrome.tabs.create({\n                url: `${baseUrl}${path}`,\n            });\n            return { success: true };\n        }\n\n        default:\n            return { success: false, error: 'Unknown message type' };\n    }\n}\n\n/**\n * Merge API jobs with local jobs, preferring API data.\n */\nfunction mergeJobs(apiJobs: SavedJob[], localJobs: SavedJob[]): SavedJob[] {\n    const jobMap = new Map<string, SavedJob>();\n\n    // Add local jobs first\n    for (const job of localJobs) {\n        jobMap.set(job.url, job);\n    }\n\n    // Overwrite with API jobs (they have scores)\n    for (const job of apiJobs) {\n        jobMap.set(job.url, job);\n    }\n\n    // Sort by captured time, most recent first\n    return Array.from(jobMap.values())\n        .sort((a, b) => b.capturedAt - a.capturedAt);\n}\n\n// Initialize badge on install\nchrome.runtime.onInstalled.addListener(async () => {\n    console.log('[RIYP] Extension installed');\n    await updateBadge();\n\n    // Check auth status on install\n    const { authenticated } = await checkAuth();\n    console.log('[RIYP] Auth status:', authenticated);\n});\n\n// Update badge when storage changes\nchrome.storage.onChanged.addListener((changes, namespace) => {\n    if (namespace === 'local' && changes.riyp_extension_data) {\n        updateBadge();\n    }\n});\n\n// Export for use in popup\nexport { checkAuth, getLoginUrl, getJobsUrl };\n\nconsole.log('[RIYP] Service worker initialized');\n"],"names":["getSavedJobs","getLocalJobs"],"mappings":";;;AAMA,MAAM,WAAA,GAAc,qBAAA;AAGpB,MAAM,eAAA,GAAoC;AAAA,EACtC,WAAW,EAAC;AAAA,EACZ,WAAA,EAAa,KAAK,GAAA;AACtB,CAAA;AAKA,eAAsB,UAAA,GAAwC;AAC1D,EAAA,MAAM,SAAS,MAAM,MAAA,CAAO,OAAA,CAAQ,KAAA,CAAM,IAAI,WAAW,CAAA;AACzD,EAAA,OAAO,MAAA,CAAO,WAAW,CAAA,IAAK,eAAA;AAClC;AAKA,eAAsB,WAAW,IAAA,EAAgD;AAC7E,EAAA,MAAM,OAAA,GAAU,MAAM,UAAA,EAAW;AACjC,EAAA,MAAM,MAAA,CAAO,OAAA,CAAQ,KAAA,CAAM,GAAA,CAAI;AAAA,IAC3B,CAAC,WAAW,GAAG;AAAA,MACX,GAAG,OAAA;AAAA,MACH,GAAG,IAAA;AAAA,MACH,WAAA,EAAa,KAAK,GAAA;AAAI;AAC1B,GACH,CAAA;AACL;AAKA,eAAsB,YAAY,GAAA,EAA8B;AAC5D,EAAA,MAAM,OAAA,GAAU,MAAM,UAAA,EAAW;AAGjC,EAAA,MAAM,aAAA,GAAgB,QAAQ,SAAA,CAAU,SAAA,CAAU,CAAC,CAAA,KAAM,CAAA,CAAE,GAAA,KAAQ,GAAA,CAAI,GAAG,CAAA;AAE1E,EAAA,IAAI,iBAAiB,CAAA,EAAG;AAEpB,IAAA,OAAA,CAAQ,SAAA,CAAU,aAAa,CAAA,GAAI,GAAA;AAAA,EACvC,CAAA,MAAO;AAEH,IAAA,OAAA,CAAQ,SAAA,CAAU,QAAQ,GAAG,CAAA;AAAA,EACjC;AAGA,EAAA,OAAA,CAAQ,SAAA,GAAY,OAAA,CAAQ,SAAA,CAAU,KAAA,CAAM,GAAG,EAAE,CAAA;AAEjD,EAAA,MAAM,UAAA,CAAW,EAAE,SAAA,EAAW,OAAA,CAAQ,WAAW,CAAA;AACrD;AAKA,eAAsB,eAAe,UAAA,EAA8C;AAC/E,EAAA,MAAM,OAAA,GAAU,MAAM,UAAA,EAAW;AAEjC,EAAA,MAAM,KAAA,GAAQ,QAAQ,SAAA,CAAU,SAAA;AAAA,IAC5B,CAAC,CAAA,KAAM,CAAA,CAAE,EAAA,KAAO,UAAA,IAAc,EAAE,GAAA,KAAQ;AAAA,GAC5C;AAEA,EAAA,IAAI,UAAU,EAAA,EAAI;AACd,IAAA,OAAO,IAAA;AAAA,EACX;AAEA,EAAA,MAAM,CAAC,OAAO,CAAA,GAAI,QAAQ,SAAA,CAAU,MAAA,CAAO,OAAO,CAAC,CAAA;AACnD,EAAA,MAAM,UAAA,CAAW,EAAE,SAAA,EAAW,OAAA,CAAQ,WAAW,CAAA;AAEjD,EAAA,OAAO,OAAA;AACX;AAYA,eAAsB,YAAA,GAAoC;AACtD,EAAA,MAAM,OAAA,GAAU,MAAM,UAAA,EAAW;AACjC,EAAA,OAAO,OAAA,CAAQ,SAAA;AACnB;AAKA,eAAsB,cAAc,GAAA,EAA6D;AAC7F,EAAA,MAAM,OAAA,GAAU,MAAM,UAAA,EAAW;AACjC,EAAA,MAAM,GAAA,GAAM,QAAQ,SAAA,CAAU,IAAA,CAAK,CAAC,CAAA,KAAM,CAAA,CAAE,QAAQ,GAAG,CAAA;AACvD,EAAA,OAAO,EAAE,QAAA,EAAU,CAAC,CAAC,KAAK,GAAA,EAAI;AAClC;AAKA,eAAsB,WAAA,GAA6B;AAC/C,EAAA,MAAM,IAAA,GAAO,MAAM,YAAA,EAAa;AAChC,EAAA,MAAM,QAAQ,IAAA,CAAK,MAAA;AAEnB,EAAA,IAAI,QAAQ,CAAA,EAAG;AACX,IAAA,MAAM,MAAA,CAAO,OAAO,YAAA,CAAa,EAAE,MAAM,MAAA,CAAO,KAAK,GAAG,CAAA;AACxD,IAAA,MAAM,OAAO,MAAA,CAAO,uBAAA,CAAwB,EAAE,KAAA,EAAO,WAAW,CAAA;AAAA,EACpE,CAAA,MAAO;AACH,IAAA,MAAM,OAAO,MAAA,CAAO,YAAA,CAAa,EAAE,IAAA,EAAM,IAAI,CAAA;AAAA,EACjD;AACJ;;ACxFA,MAAA,CAAO,QAAQ,SAAA,CAAU,WAAA;AAAA,EACrB,CAAC,OAAA,EAA2B,OAAA,EAAS,YAAA,KAAwD;AACzF,IAAA,aAAA,CAAc,OAAO,CAAA,CAChB,IAAA,CAAK,YAAY,CAAA,CACjB,KAAA,CAAM,CAAC,KAAA,KAAU;AACd,MAAA,OAAA,CAAQ,KAAA,CAAM,iCAAiC,KAAK,CAAA;AACpD,MAAA,YAAA,CAAa,EAAE,OAAA,EAAS,KAAA,EAAO,KAAA,EAAO,KAAA,CAAM,SAAS,CAAA;AAAA,IACzD,CAAC,CAAA;AAGL,IAAA,OAAO,IAAA;AAAA,EACX;AACJ,CAAA;AAEA,eAAe,cAAc,OAAA,EAAuD;AAChF,EAAA,QAAQ,QAAQ,IAAA;AAAM,IAClB,KAAK,YAAA,EAAc;AACf,MAAA,MAAM,EAAE,EAAA,EAAI,IAAA,EAAK,GAAI,OAAA,CAAQ,OAAA;AAE7B,MAAA,IAAI;AAEA,QAAA,MAAM,QAAA,GAAW,MAAM,UAAA,CAAW,EAAA,EAAI,IAAI,CAAA;AAG1C,QAAA,MAAM,YAAY,QAAQ,CAAA;AAC1B,QAAA,MAAM,WAAA,EAAY;AAElB,QAAA,OAAO,EAAE,OAAA,EAAS,IAAA,EAAM,IAAA,EAAM,QAAA,EAAS;AAAA,MAC3C,SAAS,KAAA,EAAO;AAEZ,QAAA,OAAA,CAAQ,IAAA,CAAK,8CAA8C,KAAK,CAAA;AAEhE,QAAA,MAAM,QAAA,GAAqB;AAAA,UACvB,GAAG,IAAA;AAAA,UACH,KAAA,EAAO,IAAA;AAAA,UACP,SAAA,EAAW,EAAA,CAAG,KAAA,CAAM,CAAA,EAAG,GAAG;AAAA,SAC9B;AAEA,QAAA,MAAM,YAAY,QAAQ,CAAA;AAC1B,QAAA,MAAM,WAAA,EAAY;AAElB,QAAA,OAAO,EAAE,OAAA,EAAS,IAAA,EAAM,IAAA,EAAM,QAAA,EAAS;AAAA,MAC3C;AAAA,IACJ;AAAA,IAEA,KAAK,UAAA,EAAY;AACb,MAAA,IAAI;AAEA,QAAA,MAAM,OAAA,GAAU,MAAMA,cAAA,EAAa;AAGnC,QAAA,MAAM,SAAA,GAAY,MAAMC,YAAA,EAAa;AACrC,QAAA,MAAM,UAAA,GAAa,SAAA,CAAU,OAAA,EAAS,SAAS,CAAA;AAE/C,QAAA,OAAO,EAAE,OAAA,EAAS,IAAA,EAAM,IAAA,EAAM,UAAA,EAAW;AAAA,MAC7C,CAAA,CAAA,MAAQ;AAEJ,QAAA,MAAM,SAAA,GAAY,MAAMA,YAAA,EAAa;AACrC,QAAA,OAAO,EAAE,OAAA,EAAS,IAAA,EAAM,IAAA,EAAM,SAAA,EAAU;AAAA,MAC5C;AAAA,IACJ;AAAA,IAEA,KAAK,YAAA,EAAc;AACf,MAAA,MAAM,EAAE,KAAA,EAAM,GAAI,OAAA,CAAQ,OAAA;AAE1B,MAAA,IAAI;AAEA,QAAA,MAAM,UAAU,KAAK,CAAA;AAAA,MACzB,SAAS,KAAA,EAAO;AACZ,QAAA,OAAA,CAAQ,IAAA,CAAK,oDAAoD,KAAK,CAAA;AAAA,MAC1E;AAGA,MAAA,MAAM,eAAe,KAAK,CAAA;AAC1B,MAAA,MAAM,WAAA,EAAY;AAElB,MAAA,OAAO,EAAE,OAAA,EAAS,IAAA,EAAM,OAAA,EAAS,KAAA,EAAM;AAAA,IAC3C;AAAA,IAEA,KAAK,YAAA,EAAc;AACf,MAAA,MAAM,MAAA,GAAS,MAAM,SAAA,EAAU;AAC/B,MAAA,OAAO,EAAE,OAAA,EAAS,IAAA,EAAM,IAAA,EAAM,MAAA,EAAO;AAAA,IACzC;AAAA,IAEA,KAAK,iBAAA,EAAmB;AACpB,MAAA,MAAM,IAAA,GAAO,MAAMA,YAAA,EAAa;AAChC,MAAA,MAAM,GAAA,GAAM,KAAK,IAAA,CAAK,CAAC,MAAM,CAAA,CAAE,EAAA,KAAO,OAAA,CAAQ,OAAA,CAAQ,KAAK,CAAA;AAE3D,MAAA,IAAI,CAAC,GAAA,EAAK;AACN,QAAA,OAAO,EAAE,OAAA,EAAS,KAAA,EAAO,KAAA,EAAO,eAAA,EAAgB;AAAA,MACpD;AAEA,MAAA,OAAO,EAAE,SAAS,IAAA,EAAM,IAAA,EAAM,EAAE,KAAA,EAAO,GAAA,CAAI,KAAA,IAAS,CAAA,EAAE,EAAE;AAAA,IAC5D;AAAA,IAEA,KAAK,kBAAA,EAAoB;AACrB,MAAA,MAAM,EAAE,GAAA,EAAI,GAAI,OAAA,CAAQ,OAAA;AACxB,MAAA,MAAM,MAAA,GAAS,MAAM,aAAA,CAAc,GAAG,CAAA;AACtC,MAAA,OAAO;AAAA,QACH,OAAA,EAAS,IAAA;AAAA,QACT,IAAA,EAAM;AAAA,UACF,UAAU,MAAA,CAAO,QAAA;AAAA,UACjB,KAAA,EAAO,MAAA,CAAO,GAAA,EAAK,KAAA,IAAS,IAAA;AAAA,UAC5B,KAAA,EAAO,OAAO,GAAA,EAAK;AAAA;AACvB,OACJ;AAAA,IACJ;AAAA,IAEA,KAAK,aAAA,EAAe;AAChB,MAAA,MAAM,IAAA,GAAO,OAAA,CAAQ,OAAA,EAAS,IAAA,IAAQ,OAAA;AACtC,MAAA,MAAM,OAAA,GAAU,UAAA,EAAW,CAAE,OAAA,CAAQ,SAAS,EAAE,CAAA;AAChD,MAAA,MAAM,MAAA,CAAO,KAAK,MAAA,CAAO;AAAA,QACrB,GAAA,EAAK,CAAA,EAAG,OAAO,CAAA,EAAG,IAAI,CAAA;AAAA,OACzB,CAAA;AACD,MAAA,OAAO,EAAE,SAAS,IAAA,EAAK;AAAA,IAC3B;AAAA,IAEA;AACI,MAAA,OAAO,EAAE,OAAA,EAAS,KAAA,EAAO,KAAA,EAAO,sBAAA,EAAuB;AAAA;AAEnE;AAKA,SAAS,SAAA,CAAU,SAAqB,SAAA,EAAmC;AACvE,EAAA,MAAM,MAAA,uBAAa,GAAA,EAAsB;AAGzC,EAAA,KAAA,MAAW,OAAO,SAAA,EAAW;AACzB,IAAA,MAAA,CAAO,GAAA,CAAI,GAAA,CAAI,GAAA,EAAK,GAAG,CAAA;AAAA,EAC3B;AAGA,EAAA,KAAA,MAAW,OAAO,OAAA,EAAS;AACvB,IAAA,MAAA,CAAO,GAAA,CAAI,GAAA,CAAI,GAAA,EAAK,GAAG,CAAA;AAAA,EAC3B;AAGA,EAAA,OAAO,KAAA,CAAM,IAAA,CAAK,MAAA,CAAO,MAAA,EAAQ,CAAA,CAC5B,IAAA,CAAK,CAAC,CAAA,EAAG,CAAA,KAAM,CAAA,CAAE,UAAA,GAAa,EAAE,UAAU,CAAA;AACnD;AAGA,MAAA,CAAO,OAAA,CAAQ,WAAA,CAAY,WAAA,CAAY,YAAY;AAC/C,EAAA,OAAA,CAAQ,IAAI,4BAA4B,CAAA;AACxC,EAAA,MAAM,WAAA,EAAY;AAGlB,EAAA,MAAM,EAAE,aAAA,EAAc,GAAI,MAAM,SAAA,EAAU;AAC1C,EAAA,OAAA,CAAQ,GAAA,CAAI,uBAAuB,aAAa,CAAA;AACpD,CAAC,CAAA;AAGD,MAAA,CAAO,OAAA,CAAQ,SAAA,CAAU,WAAA,CAAY,CAAC,SAAS,SAAA,KAAc;AACzD,EAAA,IAAI,SAAA,KAAc,OAAA,IAAW,OAAA,CAAQ,mBAAA,EAAqB;AACtD,IAAA,WAAA,EAAY;AAAA,EAChB;AACJ,CAAC,CAAA;AAKD,OAAA,CAAQ,IAAI,mCAAmC,CAAA;;;;"}