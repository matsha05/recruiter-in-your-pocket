{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/matsha05/Desktop/dev/recruiter-in-your-pocket/web/app/api/stripe/webhook/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport Stripe from \"stripe\";\nimport { createClient } from \"@supabase/supabase-js\";\n\n// Initialize Stripe\nconst stripe = process.env.STRIPE_SECRET_KEY\n    ? new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: \"2025-11-17.clover\" })\n    : null;\n\nconst WEBHOOK_SECRET = process.env.STRIPE_WEBHOOK_SECRET;\n\n// Supabase admin client (bypasses RLS for writes)\nconst supabaseAdmin = process.env.SUPABASE_SERVICE_ROLE_KEY\n    ? createClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.SUPABASE_SERVICE_ROLE_KEY,\n        { auth: { persistSession: false } }\n    )\n    : null;\n\n// Disable body parser - Stripe requires raw body\nexport const runtime = \"nodejs\";\n\nexport async function POST(request: NextRequest) {\n    if (!stripe || !WEBHOOK_SECRET) {\n        console.error(\"[webhook] Stripe or webhook secret not configured\");\n        return new NextResponse(\"Webhook not configured\", { status: 400 });\n    }\n\n    if (!supabaseAdmin) {\n        console.error(\"[webhook] Supabase admin client not configured\");\n        return new NextResponse(\"Database not configured\", { status: 500 });\n    }\n\n    // Get raw body and signature\n    const body = await request.text();\n    const sig = request.headers.get(\"stripe-signature\");\n\n    if (!sig) {\n        console.error(\"[webhook] Missing stripe-signature header\");\n        return new NextResponse(\"Missing signature\", { status: 400 });\n    }\n\n    let event: Stripe.Event;\n\n    try {\n        event = stripe.webhooks.constructEvent(body, sig, WEBHOOK_SECRET);\n    } catch (err: any) {\n        console.error(\"[webhook] Signature verification failed:\", err.message);\n        return new NextResponse(`Webhook Error: ${err.message}`, { status: 400 });\n    }\n\n    // Handle checkout.session.completed\n    if (event.type === \"checkout.session.completed\") {\n        const session = event.data.object as Stripe.Checkout.Session;\n        const metadata = session.metadata || {};\n        const email = metadata.email || session.customer_email;\n        const tier = metadata.tier || \"24h\";\n        const metadataUserId = metadata.user_id || null;\n\n        console.log(`[webhook] checkout.session.completed for ${email}, tier: ${tier}`);\n\n        if (!email) {\n            console.error(\"[webhook] No email in session\");\n            return new NextResponse(\"No email found\", { status: 400 });\n        }\n\n        try {\n            // Find or create user by email\n            let userId = metadataUserId;\n\n            if (!userId) {\n                // Look up user by email in Supabase auth\n                const { data: users, error: listError } = await supabaseAdmin.auth.admin.listUsers();\n\n                if (!listError && users.users) {\n                    const existingUser = users.users.find(u => u.email?.toLowerCase() === email.toLowerCase());\n                    if (existingUser) {\n                        userId = existingUser.id;\n                    }\n                }\n            }\n\n            if (!userId) {\n                // Create user via Supabase Auth\n                const { data: newUser, error: createError } = await supabaseAdmin.auth.admin.createUser({\n                    email: email.toLowerCase(),\n                    email_confirm: true\n                });\n\n                if (createError) {\n                    // If user already exists, try to find them again\n                    console.log(\"[webhook] User creation failed, trying lookup:\", createError.message);\n                    const { data: users } = await supabaseAdmin.auth.admin.listUsers();\n                    const existingUser = users?.users?.find(u => u.email?.toLowerCase() === email.toLowerCase());\n                    if (existingUser) {\n                        userId = existingUser.id;\n                    }\n                } else if (newUser?.user) {\n                    userId = newUser.user.id;\n                    console.log(`[webhook] Created new user: ${userId}`);\n                }\n            }\n\n            if (!userId) {\n                throw new Error(\"Could not find or create user\");\n            }\n\n            // Update user's first name from billing if not set\n            const customerDetails = session.customer_details;\n            if (customerDetails?.name) {\n                const firstName = customerDetails.name.split(\" \")[0];\n                const { data: existingUser } = await supabaseAdmin.auth.admin.getUserById(userId);\n\n                if (existingUser?.user && !existingUser.user.user_metadata?.first_name) {\n                    await supabaseAdmin.auth.admin.updateUserById(userId, {\n                        user_metadata: {\n                            ...existingUser.user.user_metadata,\n                            first_name: firstName\n                        }\n                    });\n                    console.log(`[webhook] Updated user first_name: ${firstName}`);\n                }\n            }\n\n            // Calculate expiration\n            const nowMs = Date.now();\n            const expiresAt = tier === \"30d\"\n                ? new Date(nowMs + 30 * 24 * 60 * 60 * 1000).toISOString()\n                : new Date(nowMs + 24 * 60 * 60 * 1000).toISOString();\n\n            // Create pass in database\n            const passId = crypto.randomUUID();\n            const { error: passError } = await supabaseAdmin\n                .from(\"passes\")\n                .insert({\n                    id: passId,\n                    user_id: userId,\n                    tier: tier,\n                    purchased_at: new Date().toISOString(),\n                    expires_at: expiresAt,\n                    price_id: null,\n                    checkout_session_id: session.id,\n                    created_at: new Date().toISOString()\n                });\n\n            if (passError) {\n                console.error(\"[webhook] Failed to create pass:\", passError.message);\n                throw passError;\n            }\n\n            console.log(`[webhook] Pass created for user ${userId}, tier: ${tier}, expires: ${expiresAt}`);\n\n        } catch (err: any) {\n            console.error(\"[webhook] Error processing webhook:\", err.message);\n            return new NextResponse(`Processing Error: ${err.message}`, { status: 500 });\n        }\n    }\n\n    return NextResponse.json({ received: true });\n}\n"],"names":[],"mappings":"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"}}]
}